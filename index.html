<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Transformation Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <!-- Chosen Palette: Refined Indigo (Gray-50, White, Gray-900, Indigo-600 Accent) -->
    <!-- Application Structure Plan: A 6-section SPA. Profile now includes 'goal', 'diet', 'frequency', 'workoutTime', 'age', and 'height'. This allows for BMR/BMI calculation and dynamic, age-based workout guidance. -->
    <!-- Visualization & Content Choices: Report Info: User-defined Goal -> Goal: Motivate -> Viz: Line Chart -> Interaction: Dynamic (user data) -> Justification: Visualizes user's personal goal vs. actual progress -> Library: Chart.js. | Report Info: User-defined Workout Goal + Frequency -> Goal: Organize -> Viz: Dynamic Button/Detail List -> Interaction: Profile selections change data source from a 9-plan matrix -> Justification: Fully personalizes the workout plan -> Library: Vanilla JS. | Report Info: User-defined Age/Height/Weight -> Goal: Inform -> Viz: Dynamic Text (BMI/BMR) -> Interaction: Profile data auto-calculates metrics -> Justification: Provides key health data -> Library: Vanilla JS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }
        .nav-btn {
            @apply px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors duration-150 border-b-2 border-transparent;
        }
        /* DESIGN UPDATE: Cleaner "tab" look for active nav item */
        .nav-btn.active {
            @apply bg-white text-indigo-600 font-semibold border-b-2 border-indigo-600;
        }
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
        /* DESIGN UPDATE: Softer shadow, added border for definition */
        .card {
            @apply bg-white shadow-lg rounded-xl p-8 md:p-10 overflow-hidden border border-gray-100;
        }
        .day-btn {
            @apply px-4 py-2 rounded-md text-sm font-medium text-gray-600 bg-white shadow-sm border border-gray-200 hover:bg-gray-100 transition-colors duration-150 flex-1;
        }
        .day-btn.active {
            @apply bg-indigo-600 text-white shadow-inner;
        }
        .workout-btn {
            @apply w-full text-left px-4 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors duration-150;
        }
        .workout-btn.active {
            @apply bg-indigo-50 text-indigo-700;
        }
        .meal-card-header {
            @apply cursor-pointer bg-gray-50 p-4 rounded-md flex justify-between items-center;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        /* DESIGN UPDATE: New Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px; /* Increased gap */
            max-width: 400px; /* Constrain width */
            margin: 0 auto; /* Center it */
        }
        .calendar-day-header {
            @apply flex items-center justify-center text-xs font-semibold text-gray-500 uppercase;
        }
        .calendar-day {
            /* Circle shape */
            @apply w-10 h-10 flex items-center justify-center text-sm font-medium rounded-full bg-gray-100 text-gray-500;
        }
        .calendar-day.completed {
            /* Solid green circle for completed */
            @apply bg-green-500 text-white font-bold;
        }
        .calendar-day.today {
            /* Ring highlight for today */
            @apply ring-2 ring-indigo-500 ring-offset-2;
        }
        .modal-overlay {
            @apply fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-20;
        }
        .modal-content {
            @apply bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full;
        }
        .goal-choice-btn {
            @apply w-full text-left p-4 border border-gray-300 rounded-lg hover:bg-indigo-50 cursor-pointer transition-colors duration-150;
        }
        .goal-choice-btn.active {
            /* More obvious selection */
            @apply bg-indigo-50 border-indigo-600 ring-2 ring-indigo-300;
        }
        .goal-choice-btn .check-icon {
            display: none;
        }
        .goal-choice-btn.active .check-icon {
            /* Larger, more visible checkmark */
            display: inline-block;
            @apply text-2xl text-indigo-600 font-bold;
        }
        /* DESIGN UPDATE: Better focus state */
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition-colors duration-150;
        }
        /* DESIGN UPDATE: Softer shadow, better transition */
        .btn-primary {
            @apply w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:shadow-lg hover:bg-indigo-700 transition-all duration-150;
        }
        .btn-danger {
            @apply w-full bg-red-600 text-white px-6 py-3 rounded-lg font-medium shadow-md hover:shadow-lg hover:bg-red-700 transition-all duration-150;
        }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-4">Welcome!</h2>
            <p class="text-lg text-gray-600 mb-6">Let's personalize your plan. Please set up your profile to get started.</p>
            <button id="go-to-profile-btn" class="btn-primary py-3">
                Go to Profile Setup
            </button>
        </div>
    </div>

    <header class="sticky top-0 bg-white shadow-sm z-10"> <!-- Lighter shadow -->
        <nav class="container mx-auto px-4 py-3 flex justify-center space-x-1 md:space-x-2">
            <button class="nav-btn active" data-target="dashboard-page">Dashboard</button>
            <button class="nav-btn" data-target="tracker-page">Tracker</button>
            <button class="nav-btn" data-target="diet-page">Diet Plan</button>
            <button class="nav-btn" data-target="workout-page">Workout Plan</button>
            <button class="nav-btn" data-target="goals-page">Goals & Schedule</button>
            <button class="nav-btn" data-target="profile-page">Profile</button>
        </nav>
    </header>

    <!-- Increased main padding -->
    <main class="container mx-auto p-6 md:p-12">

        <!-- =======================
             DASHBOARD PAGE
        ======================== -->
        <section class="page-section active" id="dashboard-page">
            <div class="mb-10"> <!-- Increased margin -->
                <h1 id="dashboard-title" class="text-3xl font-extrabold text-gray-900 mb-2">Welcome!</h1>
                <p class="text-lg text-gray-600">Use this dashboard to see your workout and full daily schedule. Select a day to get started.</p>
            </div>

            <div class="mb-10"> <!-- Increased margin -->
                <div class="flex flex-wrap gap-2">
                    <button class="day-btn" data-day="sun">Sun</button>
                    <button class="day-btn" data-day="mon">Mon</button>
                    <button class="day-btn" data-day="tue">Tue</button>
                    <button class="day-btn" data-day="wed">Wed</button>
                    <button class="day-btn" data-day="thu">Thu</button>
                    <button class="day-btn" data-day="fri">Fri</button>
                    <button class="day-btn" data-day="sat">Sat</button>
                </div>
            </div>
            
            <!-- Increased gap -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="flex flex-col gap-10"> <!-- Increased gap -->
                    <div class="card">
                        <h2 class="text-xl font-bold text-indigo-700 mb-2">Today's Workout</h2>
                        <!-- NEW: Subtitle for active plan -->
                        <p id="dashboard-workout-subtitle" class="text-sm text-gray-500 mb-6">Loading plan...</p>
                        <div id="dashboard-workout">
                            <p class="text-gray-500">Select a day above to see your plan.</p>
                        </div>
                        <div id="workout-complete-container" class="mt-6"></div>
                    </div>

                    <div class="card">
                        <h2 class="text-xl font-bold text-indigo-700 mb-6">Daily Water Tracker</h2>
                        <div class="flex items-center justify-center space-x-4">
                            <button id="water-minus-btn" class="bg-white border border-gray-300 text-gray-700 rounded-full w-10 h-10 text-2xl font-bold hover:bg-gray-50">-</button>
                            <span id="water-count" class="text-3xl font-bold text-indigo-600">0</span>
                            <span class="text-xl text-gray-500">/ 16 glasses</span>
                            <button id="water-plus-btn" class="bg-indigo-600 text-white rounded-full w-10 h-10 text-2xl font-bold hover:bg-indigo-700">+</button>
                        </div>
                        <p class="text-center text-sm text-gray-500 mt-3">(Resets daily. 16 glasses ≈ 4 liters)</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-bold text-indigo-700 mb-6">Today's Schedule & Meals</h2>
                    <div id="dashboard-schedule" class="max-h-[550px] overflow-y-auto pr-2">
                        <p class="text-gray-500">Select a day above to see your full schedule.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- =======================
             TRACKER PAGE
        ======================== -->
        <section class="page-section" id="tracker-page">
            <div class="mb-10"> <!-- Increased margin -->
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">My Progress Tracker</h1>
                <p class="text-lg text-gray-600">Log your weight to see your progress plotted on the chart and review your workout consistency.</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10"> <!-- Increased gap -->
                <div class="card">
                    <h2 class="text-xl font-bold text-indigo-700 mb-6">Log Your Weight</h2>
                    <div class="flex space-x-2">
                        <input type="number" id="weight-input" placeholder="Enter weight in kg (e.g., 89.5)" class="input-field flex-1">
                        <button id="log-weight-btn" class="btn-primary px-6 py-3 w-auto">Log</button>
                    </div>
                    
                    <h2 class="text-xl font-bold text-indigo-700 my-6">Weight History</h2>
                    <div class="overflow-y-auto max-h-64">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Weight (kg)</th>
                                </tr>
                            </thead>
                            <tbody id="weight-history-table">
                                <!-- Rows will be injected by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-bold text-indigo-700 mb-6">Workout Consistency Calendar</h2>
                    <p class="text-gray-600 mb-6">Days you marked 'Complete Workout' on the Dashboard will appear in green. Don't break the chain!</p>
                    <!-- DESIGN UPDATE: Calendar grid is now styled and centered -->
                    <div class="calendar-grid" id="consistency-calendar">
                        <!-- Calendar days will be injected by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- =======================
             DIET PLAN PAGE
        ======================== -->
        <section class="page-section" id="diet-page">
             <div class="mb-10"> <!-- Increased margin -->
                <h1 id="diet-plan-title" class="text-3xl font-extrabold text-gray-900 mb-2">Pillar 1: Your Diet Plan</h1>
                <p id="diet-plan-description" class="text-lg text-gray-600">This plan is based on your profile. Explore the core principles and all meal options here.</p>
            </div>

            <div class="card mb-10"> <!-- Increased margin -->
                <h2 class="text-xl font-bold text-indigo-700 mb-6">Core Dietary Principles</h2>
                <ul class="list-disc list-inside space-y-3 text-gray-700"> <!-- Increased spacing -->
                    <li><strong>Water is Your Best Friend:</strong> Drink 3-4 liters per day. Start with a liter first thing in the morning.</li>
                    <li><strong>Protein in Every Meal:</strong> This is your #1 priority. Focus on lean sources to stay full and maintain muscle.</li>
                    <li><strong>Cut Out "White" Foods:</strong> No sugar, white flour (maida), or fried foods.</li>
                    <li><strong>Embrace Fiber:</strong> Eat a large salad with lunch and dinner to stay full.</li>
                    <li><strong>Smart Carbs:</strong> Choose wholewheat roti, brown rice, or quinoa over white rice.</li>
                </ul>
            </div>

            <h2 class="text-2xl font-bold text-gray-900 mb-6">Sample Meal Structure</h2>
            <div id="diet-plan-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-10"> <!-- Increased gap -->
                <!-- Meal cards will be built by JS -->
            </div>
        </section>

        <!-- =======================
             WORKOUT PLAN PAGE
        ======================== -->
        <section class="page-section" id="workout-page">
            <div class="mb-10"> <!-- Increased margin -->
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Pillar 2: Your Personalized Workout Plan</h1>
                <p class="text-lg text-gray-600">This plan is dynamically generated based on the "Primary Goal" you set in your profile.</p>
            </div>
            
            <div class="card mb-10"> <!-- Increased margin -->
                <h2 class="text-xl font-bold text-indigo-700 mb-6">Your 80-Minute Session</h2>
                <ul class="list-disc list-inside space-y-3 text-gray-700"> <!-- Increased spacing -->
                    <li><strong>Warm-up (10 min):</strong> 5 min light jog/incline walk + 5 min dynamic stretches.</li>
                    <li><strong>Resistance Training (45-50 min):</strong> The core of your workout.</li>
                    <li><strong>Cardio (20 min):</strong> High-Intensity or Steady State.</li>
                    <li><strong>Cooldown (5 min):</strong> Static stretching (hold stretches for 20-30 seconds).</li>
                </ul>
            </div>

            <!-- NEW: Age-Based Guidance Card -->
            <div id="age-guidance-card" class="card mb-10 bg-indigo-50 border-indigo-200 hidden">
                <h2 id="age-guidance-title" class="text-xl font-bold text-indigo-700 mb-4"></h2>
                <p id="age-guidance-content" class="text-indigo-800"></p>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold text-indigo-700 mb-2" id="workout-plan-title">Your Workout Plan</h2>
                <!-- NEW: Subtitle for active plan -->
                <p id="workout-plan-description" class="text-lg text-gray-600 mb-8">Set your goal on the Profile page to see your plan.</p>
                <!-- NEW: Container for PHASES -->
                <div class="space-y-10" id="workout-plan-container">
                    <!-- Workout plan phases will be dynamically injected here -->
                </div>
            </div>
        </section>

        <!-- =======================
             GOALS & SCHEDULE PAGE
        ======================== -->
        <section class="page-section" id="goals-page">
            <div class="mb-10"> <!-- Increased margin -->
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Pillar 3: Goals, Schedule & Sleep</h1>
                <p class="text-lg text-gray-600">This section covers your primary goal, realistic outlook, and sleep schedule. The chart below visualizes your weight loss target based on your profile.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10"> <!-- Increased gap -->
                <div class="card">
                    <h2 class="text-xl font-bold text-indigo-700 mb-6" id="goal-chart-title">Your Goal Chart</h2>
                    <div class="chart-container">
                        <canvas id="goal-chart"></canvas>
                    </div>
                    <p class="text-sm text-gray-500 mt-3 text-center">Log your weight on the "Tracker" page to see your progress here!</p>
                </div>
                <div class="card">
                    <!-- NEW: Health Metrics Section -->
                    <div class="mb-8 border-b border-gray-200 pb-8">
                        <h2 class="text-xl font-bold text-indigo-700 mb-6">Your Health Metrics</h2>
                        <div class="space-y-4">
                            <div>
                                <span id="bmi-display" class="text-lg font-semibold text-gray-800">Your BMI: --</span>
                                <p class="text-sm text-gray-500">Body Mass Index, a measure of body fat.</p>
                            </div>
                            <div>
                                <span id="bmr-display" class="text-lg font-semibold text-gray-800">Your Est. BMR: --</span>
                                <p class="text-sm text-gray-500">Basal Metabolic Rate. Calories your body burns at rest.</p>
                            </div>
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-indigo-700 mb-6">Sleep & Sample Schedule</h2>
                    <p class="text-gray-700 mb-4">Poor sleep = bad recovery, more hunger, and no energy.</p>
                    
                    <h3 class="text-lg font-semibold text-gray-800">Your Goal: 7.5-8 hours</h3>
                    <p class="text-gray-700 mb-6">This is a guideline. Your personal schedule may vary.</p>
                    
                    <h3 class="text-lg font-semibold text-gray-800">Sleep Hygiene</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 mb-6">
                        <li>No phone/laptop/TV for 30-60 minutes before bed.</li>
                        <li>Read a book.</li>
                        <li>Make your room dark and cool.</li>
                        <li>Try to wake up and sleep at the same time every day.</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- =======================
             PROFILE PAGE
        ======================== -->
        <section class="page-section" id="profile-page">
            <div class="mb-10"> <!-- Increased margin -->
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">My Profile</h1>
                <p class="text-lg text-gray-600">This information is saved locally on your device and personalizes the app for you.</p>
            </div>

            <div class="card max-w-2xl mx-auto">
                <div class="space-y-8"> <!-- Increased spacing -->
                    <div>
                        <label for="profile-name" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                        <input type="text" id="profile-name" class="input-field" placeholder="Enter your name">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- NEW: Age Input -->
                        <div>
                            <label for="profile-age" class="block text-sm font-medium text-gray-700 mb-1">Your Age</label>
                            <input type="number" id="profile-age" class="input-field" placeholder="e.g., 25">
                        </div>
                        <!-- NEW: Height Input -->
                        <div>
                            <label for="profile-height" class="block text-sm font-medium text-gray-700 mb-1">Your Height (in cm)</label>
                            <input type="number" id="profile-height" class="input-field" placeholder="e.g., 183">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label for="profile-start-weight" class="block text-sm font-medium text-gray-700 mb-1">Starting Weight (kg)</label>
                            <input type="number" id="profile-start-weight" class="input-field" placeholder="e.g., 90">
                        </div>
                        <div>
                            <label for="profile-goal-weight" class="block text-sm font-medium text-gray-700 mb-1">Goal Weight (kg)</label>
                            <input type="number" id="profile-goal-weight" class="input-field" placeholder="e.g., 80">
                        </div>
                    </div>

                    <div>
                        <label for="profile-duration" class="block text-sm font-medium text-gray-700 mb-1">Plan Duration (in weeks)</label>
                        <input type="number" id="profile-duration" class="input-field" placeholder="e.g., 8, 12, 24">
                    </div>

                    <!-- NEW: Dietary Preference -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">What is your dietary preference?</label>
                        <div class="flex flex-col sm:flex-row gap-4" id="diet-choices">
                            <button class="goal-choice-btn flex-1" data-diet="veg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-semibold text-gray-800">Vegetarian</span>
                                        <p class="text-sm text-gray-600">Paneer, Tofu, Lentils, Sattu</p>
                                    </div>
                                    <span class="check-icon text-2xl text-indigo-600">✓</span>
                                </div>
                            </button>
                            <button class="goal-choice-btn flex-1" data-diet="nonVeg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-semibold text-gray-800">Non-Vegetarian</span>
                                        <p class="text-sm text-gray-600">Eggs, Chicken, Fish, Lentils</p>
                                    </div>
                                    <span class="check-icon text-2xl text-indigo-600">✓</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- NEW: Workout Frequency -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">How many days per week can you train?</label>
                        <div class="flex flex-col sm:flex-row gap-4" id="frequency-choices">
                            <button class="goal-choice-btn flex-1" data-frequency="3day">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-800">3 Days / Week</span>
                                    <span class="check-icon text-2xl text-indigo-600">✓</span>
                                </div>
                            </button>
                             <button class="goal-choice-btn flex-1" data-frequency="4day">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-800">4 Days / Week</span>
                                    <span class="check-icon text-2xl text-indigo-600">✓</span>
                                </div>
                            </button>
                             <button class="goal-choice-btn flex-1" data-frequency="5day">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-800">5 Days / Week</span>
                                    <span class="check-icon text-2xl text-indigo-600">✓</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- NEW: Workout Time -->
                    <div>
                        <label for="profile-workout-time" class="block text-sm font-medium text-gray-700 mb-2">What time do you start your workout?</label>
                        <select id="profile-workout-time" class="input-field">
                            <!-- Options will be generated by JS -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">What is your primary fitness goal?</label>
                        <div class="space-y-3" id="goal-choices">
                            <button class="goal-choice-btn" data-goal="fatLoss">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-semibold text-gray-800">Lose Weight (Fat Loss)</span>
                                        <p class="text-sm text-gray-600">Focus on calorie deficit, high-intensity, and upper/lower splits.</p>
                                    </div>
                                    <span class="check-icon text-2xl text-indigo-600">✓</span>
                                </div>
                            </button>
                            <button class="goal-choice-btn" data-goal="muscle">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-semibold text-gray-800">Build Muscle (Hypertrophy)</span>
                                        <p class="text-sm text-gray-600">Focus on volume, progressive overload, and a Push/Pull/Legs split.</p>
                                    </div>
                                    <span class="check-icon text-2xl text-indigo-600">✓</span>
                                </div>
                            </button>
                            <button class="goal-choice-btn" data-goal="fitness">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-semibold text-gray-800">General Fitness (Maintenance)</span>
                                        <p class="text-sm text-gray-600">Focus on consistency and full-body workouts. (Great for beginners)</p>
                                    </div>
                                    <span class="check-icon text-2xl text-indigo-600">✓</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 pt-4"> <!-- Added padding top -->
                        <button id="save-profile-btn" class="btn-primary">
                            Save Profile
                        </button>
                        <button id="reset-app-btn" class="btn-danger">
                            Reset App Data
                        </button>
                    </div>
                    <p id="profile-saved-msg" class="text-center text-green-600 font-medium hidden">Profile Saved! Your app is now personalized.</p>
                </div>
            </div>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- App Data (Static) ---
            // NEW: WORKOUT PLANS ARE NOW A 3x3 MATRIX (Goal x Frequency)
            const appData = {
                workoutPlans: {
                    fatLoss: {
                        '3day': {
                            name: "3-Day Fat Loss Plan",
                            description: "High-intensity full-body workouts to maximize calorie burn in 3 days.",
                            phases: [
                                {
                                    name: "Phase 1: Foundation (Weeks 1-4)",
                                    description: "Focus on compound movements and conditioning.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Full Body A", exercises: ["Goblet Squats: 3x10-15", "Push-ups: 3x to failure", "Dumbbell Rows: 3x10-12 (each arm)", "Plank: 3x60s", "Cardio: 20 min HIIT"] },
                                        { day: "Day 2 (Wed)", key: "wed", title: "Full Body B", exercises: ["Romanian Deadlifts (DB): 3x12-15", "Overhead Press (DB): 3x10-15", "Lat Pulldown: 3x10-15", "Walking Lunges: 3x10 (each leg)", "Cardio: 20 min HIIT"] },
                                        { day: "Day 3 (Fri)", key: "fri", title: "Full Body C", exercises: ["Leg Press: 3x15-20", "Incline DB Press: 3x10-15", "Seated Cable Row: 3x10-15", "Kettlebell Swings (or DB): 3x20", "Cardio: 20 min HIIT"] },
                                        { day: "Day 4 (Tue)", key: "tue", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 5 (Thu)", key: "thu", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Intensity (Weeks 5+)",
                                    description: "Increase metabolic stress with supersets and circuits.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Full Body A (Circuit)", exercises: ["Squat to Press (DB): 3x15", "Renegade Rows: 3x10 (each arm)", "Push-ups: 3x to failure", "Plank: 3x90s", "Cardio: 25 min HIIT"] },
                                        { day: "Day 2 (Wed)", key: "wed", title: "Full Body B (Circuit)", exercises: ["Deadlifts (DB): 3x15", "Incline DB Press: 3x12-15", "Pull-ups (Assisted): 3x to failure", "Walking Lunges: 3x12 (each leg)", "Cardio: 25 min HIIT"] },
                                        { day: "Day 3 (Fri)", key: "fri", title: "Full Body C (Circuit)", exercises: ["Leg Press: 3x20", "Overhead Press (DB): 3x12-15", "Lat Pulldown: 3x12-15", "Kettlebell Swings: 3x25", "Cardio: 25 min HIIT"] },
                                        { day: "Day 4 (Tue)", key: "tue", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 5 (Thu)", key: "thu", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        },
                        '4day': {
                            name: "4-Day Fat Loss Plan",
                            description: "Classic Upper/Lower split to build muscle and burn fat.",
                            phases: [
                                {
                                    name: "Phase 1: Foundation (Weeks 1-4)",
                                    description: "Focus on building strength and work capacity with compound lifts.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A", exercises: ["Bench Press: 3x8-12", "Lat Pulldown: 3x10-15", "Shoulder Press: 3x10-12", "Dumbbell Curls: 2x12-15", "Tricep Pushdowns: 2x12-15", "Cardio: 20 min HIIT"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A", exercises: ["Squats: 3x8-12", "Romanian Deadlifts: 3x10-15", "Leg Press: 3x12-15", "Calf Raises: 3x15-20", "Ab Crunches: 3x20", "Cardio: 20 min Steady Cycle"] },
                                        { day: "Day 3 (Thu)", key: "thu", title: "Upper Body B", exercises: ["Incline DB Press: 3x10-15", "Seated Cable Row: 3x10-15", "Lateral Raises: 3x15-20", "Hammer Curls: 2x12-15", "Overhead Extension: 2x12-15", "Cardio: 20 min HIIT"] },
                                        { day: "Day 4 (Fri)", key: "fri", title: "Lower Body B", exercises: ["Deadlifts: 3x6-10", "Walking Lunges: 3x10-12 (each leg)", "Leg Curls: 3x15-20", "Leg Extensions: 3x15-20", "Plank: 3x60s", "Cardio: 20 min Steady"] },
                                        { day: "Day 5 (Wed)", key: "wed", title: "Active Rest", exercises: ["Cardio: 30-40 min light-moderate intensity (e.g., Incline Walk)"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Intensity (Weeks 5+)",
                                    description: "Increase intensity with more volume and supersets.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A (Intensity)", exercises: ["Bench Press: 4x8-10", "Lat Pulldown: 4x10-12", "Shoulder Press: 3x10-12", "Superset: DB Curls (3x12) & Tricep Pushdowns (3x15)", "Cardio: 25 min HIIT"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A (Intensity)", exercises: ["Squats: 4x8-10", "Romanian Deadlifts: 3x10-12", "Leg Press: 4x15-20", "Calf Raises: 4x20", "Hanging Knee Raises: 3x15", "Cardio: 25 min Steady"] },
                                        { day: "Day 3 (Thu)", key: "thu", title: "Upper Body B (Intensity)", exercises: ["Incline DB Press: 4x10-12", "Seated Cable Row: 4x10-12", "Lateral Raises: 4x15-20", "Superset: Hammer Curls (3x12) & Overhead Extension (3x15)", "Cardio: 25 min HIIT"] },
                                        { day: "Day 4 (Fri)", key: "fri", title: "Lower Body B (Intensity)", exercises: ["Deadlifts: 4x6-8", "Walking Lunges: 3x12 (each leg)", "Leg Curls: 4x15-20", "Leg Extensions: 4x15-20", "Plank: 3x90s", "Cardio: 25 min Steady"] },
                                        { day: "Day 5 (Wed)", key: "wed", title: "Active Rest", exercises: ["Cardio: 40 min light-moderate intensity"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        },
                        '5day': {
                            name: "5-Day Fat Loss Plan",
                            description: "High-frequency Upper/Lower split to maximize weekly volume and calorie burn.",
                            phases: [
                                {
                                    name: "Phase 1: Foundation (Weeks 1-4)",
                                    description: "Focus on building strength and work capacity with compound lifts.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A", exercises: ["Bench Press: 3x8-12", "Lat Pulldown: 3x10-15", "Shoulder Press: 3x10-12", "Dumbbell Curls: 2x12-15", "Tricep Pushdowns: 2x12-15", "Cardio: 20 min HIIT Treadmill"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A", exercises: ["Squats: 3x8-12", "Romanian Deadlifts: 3x10-15", "Leg Press: 3x12-15", "Calf Raises: 3x15-20", "Ab Crunches: 3x20", "Cardio: 20 min Steady Cycle"] },
                                        { day: "Day 3 (Wed)", key: "wed", title: "Upper Body B", exercises: ["Incline DB Press: 3x10-15", "Seated Cable Row: 3x10-15", "Lateral Raises: 3x15-20", "Hammer Curls: 2x12-15", "Overhead Extension: 2x12-15", "Cardio: 20 min HIIT Elliptical"] },
                                        { day: "Day 4 (Thu)", key: "thu", title: "Lower Body B", exercises: ["Deadlifts: 3x6-10", "Walking Lunges: 3x10-12 (each leg)", "Leg Curls: 3x15-20", "Leg Extensions: 3x15-20", "Plank: 3x60s", "Cardio: 20 min Steady StairMaster"] },
                                        { day: "Day 5 (Fri)", key: "fri", title: "Full Body / Active Rest", exercises: ["Cardio: 30-40 min light-moderate intensity (e.g., Incline Walk) or a light full-body circuit."] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Intensity (Weeks 5+)",
                                    description: "Increase intensity with more volume, supersets, and HIIT cardio.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A (Intensity)", exercises: ["Bench Press: 4x8-10", "Lat Pulldown: 4x10-12", "Shoulder Press: 3x10-12", "Superset: DB Curls (3x12) & Tricep Pushdowns (3x15)", "Cardio: 25 min HIIT"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A (Intensity)", exercises: ["Squats: 4x8-10", "Romanian Deadlifts: 3x10-12", "Leg Press: 4x15-20", "Calf Raises: 4x20", "Hanging Knee Raises: 3x15", "Cardio: 25 min Steady"] },
                                        { day: "Day 3 (Wed)", key: "wed", title: "Upper Body B (Intensity)", exercises: ["Incline DB Press: 4x10-12", "Seated Cable Row: 4x10-12", "Lateral Raises: 4x15-20", "Superset: Hammer Curls (3x12) & Overhead Extension (3x15)", "Cardio: 25 min HIIT"] },
                                        { day: "Day 4 (Thu)", key: "thu", title: "Lower Body B (Intensity)", exercises: ["Deadlifts: 4x6-8", "Walking Lunges: 3x12 (each leg)", "Leg Curls: 4x15-20", "Leg Extensions: 4x15-20", "Plank: 3x90s", "Cardio: 25 min Steady"] },
                                        { day: "Day 5 (Fri)", key: "fri", title: "Full Body Circuit", exercises: ["Goblet Squats: 3x15", "Push-ups: 3x to failure", "Dumbbell Rows: 3x12 (each arm)", "Kettlebell Swings (or DB): 3x20", "Plank: 3x90s"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        }
                    },
                    muscle: {
                        '3day': {
                            name: "3-Day Muscle Building Plan",
                            description: "A 3-day full-body split focusing on compound lifts for hypertrophy.",
                            phases: [
                                {
                                    name: "Phase 1: Foundation (Weeks 1-6)",
                                    description: "Focus on learning the movements and building a consistent habit.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Full Body A (Squat Focus)", exercises: ["Barbell Squats: 4x6-10", "Dumbbell Bench Press: 3x8-12", "Dumbbell Row: 3x8-12 (each arm)", "Overhead Press: 3x8-12", "Bicep Curls: 2x12-15", "Tricep Extension: 2x12-15"] },
                                        { day: "Day 2 (Wed)", key: "wed", title: "Full Body B (Bench Focus)", exercises: ["Barbell Bench Press: 4x6-10", "Leg Press: 3x10-15", "Lat Pulldown: 3x8-12", "Lateral Raises: 3x12-15", "Plank: 3x60s"] },
                                        { day: "Day 3 (Fri)", key: "fri", title: "Full Body C (Deadlift Focus)", exercises: ["Deadlifts: 4x5-8", "Incline Dumbbell Press: 3x10-15", "Seated Cable Row: 3x10-15", "Walking Lunges: 3x10 (each leg)", "Hammer Curls: 2x12-15", "Tricep Pushdowns: 2x12-15"] },
                                        { day: "Day 4 (Tue)", key: "tue", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 5 (Thu)", key: "thu", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Intensity (Weeks 7+)",
                                    description: "Increase volume and add accessory movements.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Full Body A (Squat Focus)", exercises: ["Barbell Squats: 5x5", "Incline DB Press: 3x10-12", "Barbell Row: 3x8-10", "Arnold Press: 3x10-12", "Bicep Curls: 3x12-15", "Tricep Extension: 3x12-15"] },
                                        { day: "Day 2 (Wed)", key: "wed", title: "Full Body B (Bench Focus)", exercises: ["Barbell Bench Press: 5x5", "Leg Press: 4x12-15", "Pull-ups (Assisted): 3x to failure", "Lateral Raises: 4x15-20", "Hanging Knee Raises: 3x15"] },
                                        { day: "Day 3 (Fri)", key: "fri", title: "Full Body C (Deadlift Focus)", exercises: ["Deadlifts: 5x5", "Dumbbell Bench Press: 3x10-12", "T-Bar Row: 3x8-10", "Bulgarian Split Squats: 3x10 (each leg)", "Hammer Curls: 3x12-15", "Tricep Pushdowns: 3x12-15"] },
                                        { day: "Day 4 (Tue)", key: "tue", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 5 (Thu)", key: "thu", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        },
                        '4day': {
                            name: "4-Day Muscle Building Plan",
                            description: "Classic Upper/Lower split with a focus on hypertrophy.",
                            phases: [
                                {
                                    name: "Phase 1: Foundation (Weeks 1-6)",
                                    description: "Focus on increasing volume on compound lifts.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A (Strength)", exercises: ["Barbell Bench Press: 4x6-8", "Barbell Row: 4x6-8", "Overhead Press: 3x8-10", "Lat Pulldown: 3x8-10", "DB Curls: 2x10-12", "Tricep Pushdowns: 2x10-12"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A (Strength)", exercises: ["Barbell Squats: 4x6-8", "Romanian Deadlifts: 3x8-10", "Leg Press: 3x10-12", "Calf Raises: 3x10-15", "Ab Crunches: 3x15"] },
                                        { day: "Day 3 (Thu)", key: "thu", title: "Upper Body B (Hypertrophy)", exercises: ["Incline DB Press: 3x10-15", "Seated Cable Row: 3x10-15", "DB Shoulder Press: 3x10-15", "Lateral Raises: 3x15-20", "Hammer Curls: 3x10-15", "Overhead Extension: 3x10-15"] },
                                        { day: "Day 4 (Fri)", key: "fri", title: "Lower Body B (Hypertrophy)", exercises: ["Leg Press: 4x15-20", "Walking Lunges: 3x10-12 (each leg)", "Leg Curls: 3x15-20", "Leg Extensions: 3x15-20", "Plank: 3x60s"] },
                                        { day: "Day 5 (Wed)", key: "wed", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Intensity (Weeks 7+)",
                                    description: "Increase intensity and volume.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A (Strength)", exercises: ["Barbell Bench Press: 5x5", "Barbell Row: 5x5", "Overhead Press: 4x6-8", "Pull-ups (Assisted): 3x to failure", "DB Curls: 3x10-12", "Tricep Pushdowns: 3x10-12"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A (Strength)", exercises: ["Barbell Squats: 5x5", "Romanian Deadlifts: 4x8-10", "Leg Press: 3x10-12", "Calf Raises: 4x10-15", "Hanging Knee Raises: 3x15"] },
                                        { day: "Day 3 (Thu)", key: "thu", title: "Upper Body B (Hypertrophy)", exercises: ["Incline DB Press: 4x10-15", "Seated Cable Row: 4x10-15", "DB Shoulder Press: 3x10-15", "Superset: Lateral Raises (3x15) & Face Pulls (3x15)", "Superset: Hammer Curls (3x15) & Overhead Extension (3x15)"] },
                                        { day: "Day 4 (Fri)", key: "fri", title: "Lower Body B (Hypertrophy)", exercises: ["Leg Press: 4x15-20", "Bulgarian Split Squats: 3x10-12 (each leg)", "Leg Curls: 4x15-20", "Leg Extensions: 4x15-20", "Plank: 3x90s"] },
                                        { day: "Day 5 (Wed)", key: "wed", title: "Rest Day", exercises: ["Rest or light activity (walking)."] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        },
                        '5day': {
                            name: "5-Day Muscle Building Plan",
                            description: "Classic PPL (Push, Pull, Legs) split to maximize hypertrophy.",
                            phases: [
                                {
                                    name: "Phase 1: Hypertrophy (Weeks 1-8)",
                                    description: "Focus on classic PPL split with volume.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Push (Chest, Shoulders, Triceps)", exercises: ["Barbell Bench Press: 4x6-10", "Incline Dumbbell Press: 3x8-12", "Dumbbell Shoulder Press: 3x8-12", "Dumbbell Lateral Raises: 3x12-15", "Tricep Pushdowns (Cable): 3x12-15", "Overhead Dumbbell Extension: 2x12-15"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Pull (Back, Biceps)", exercises: ["Lat Pulldown: 4x8-12", "Seated Cable Row: 3x10-15", "Bent-Over Dumbbell Row: 3x10-12 (each arm)", "Face Pulls (Cable): 3x15-20", "Dumbbell Bicep Curls: 3x10-15", "Hammer Curls: 2x12-15"] },
                                        { day: "Day 3 (Wed)", key: "wed", title: "Legs (Quads, Hamstrings, Glutes)", exercises: ["Barbell Squats: 4x8-12", "Romanian Deadlifts (RDLs): 3x10-15", "Leg Press: 3x12-20", "Leg Extensions: 3x15-20", "Leg Curls: 3x15-20", "Calf Raises: 4x15-25"] },
                                        { day: "Day 4 (Thu)", key: "thu", title: "Push (Shoulder/Chest Focus)", exercises: ["Overhead Press (Barbell): 4x6-10", "Dumbbell Bench Press: 3x8-12", "Arnold Press: 3x10-15", "Cable Crossovers: 3x12-15", "Close Grip Bench Press: 3x8-12", "Single Arm Tricep Extension: 2x12-15"] },
                                        { day: "Day 5 (Fri)", key: "fri", title: "Pull (Back/Bicep Focus)", exercises: ["Pull-ups (or Assisted): 4x to failure", "T-Bar Row: 3x8-12", "Single Arm DB Row: 3x10-12", "Reverse Pec Deck: 3x15-20", "Barbell Curls: 3x10-12", "Preacher Curls: 2x12-15"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Strength & Density (Weeks 9+)",
                                    description: "Focus on increasing strength with lower reps and adding supersets.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Push (Strength)", exercises: ["Barbell Bench Press: 5x5", "Overhead Press (Barbell): 4x6-8", "Incline Dumbbell Press: 3x8-10", "Superset: Lateral Raises (3x15) & Tricep Pushdowns (3x15)"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Pull (Strength)", exercises: ["Deadlifts: 5x5", "Pull-ups (or Assisted): 4x to failure", "Barbell Row: 4x6-8", "Superset: Face Pulls (3x15) & Bicep Curls (3x10)"] },
                                        { day: "Day 3 (Wed)", key: "wed", title: "Legs (Strength)", exercises: ["Barbell Squats: 5x5", "Romanian Deadlifts (RDLs): 4x8-10", "Leg Press: 3x10-12", "Leg Extensions: 3x15", "Leg Curls: 3x15", "Calf Raises: 4x15"] },
                                        { day: "Day 4 (Thu)", key: "thu", title: "Push (Hypertrophy)", exercises: ["Dumbbell Bench Press: 4x10-12", "Arnold Press: 3x10-12", "Cable Crossovers: 3x15-20", "Close Grip Bench Press: 3x10-12", "Overhead Dumbbell Extension: 3x12-15"] },
                                        { day: "Day 5 (Fri)", key: "fri", title: "Pull (Hypertrophy)", exercises: ["Lat Pulldown: 4x10-12", "Seated Cable Row: 4x12-15", "Single Arm DB Row: 3x10-12", "Dumbbell Bicep Curls: 3x12-15", "Hammer Curls: 3x12-15"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        }
                    },
                    fitness: {
                        '3day': {
                            name: "3-Day General Fitness Plan",
                            description: "A 3-day Full Body plan perfect for beginners or maintaining fitness.",
                            phases: [
                                {
                                    name: "Phase 1: Foundation (Weeks 1-6)",
                                    description: "Focus on learning the movements and building a consistent habit.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Full Body A", exercises: ["Goblet Squats: 3x10-12", "Dumbbell Bench Press: 3x10-12", "Dumbbell Row: 3x10-12 (each arm)", "Overhead Press: 2x10-12", "Plank: 3x45s"] },
                                        { day: "Day 2 (Wed)", key: "wed", title: "Full Body B", exercises: ["Romanian Deadlifts (Dumbbell): 3x10-12", "Lat Pulldown: 3x10-12", "Push-ups (or Knee Push-ups): 3x to failure", "Leg Press: 2x12-15", "Crunches: 3x15"] },
                                        { day: "Day 3 (Fri)", key: "fri", title: "Full Body C", exercises: ["Walking Lunges: 3x10 (each leg)", "Seated Cable Row: 3x10-12", "Dumbbell Shoulder Press: 3x10-12", "Leg Curls: 3x12-15", "Side Planks: 3x30s (each side)"] },
                                        { day: "Day 4 (Tue)", key: "tue", title: "Active Rest", exercises: ["Cardio: 20-30 min light-moderate intensity (e.g., Jog or Cycle)"] },
                                        { day: "Day 5 (Thu)", key: "thu", title: "Active Rest", exercises: ["Cardio: 20-30 min light-moderate intensity (e.g., Incline Walk)"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Progression (Weeks 7+)",
                                    description: "Increase the challenge by adding weight or reps.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Full Body A (Strength)", exercises: ["Barbell Squats: 4x8-10", "Barbell Bench Press: 4x8-10", "Barbell Row: 4x8-10", "Overhead Press: 3x8-10", "Plank: 3x60s"] },
                                        { day: "Day 2 (Wed)", key: "wed", title: "Full Body B (Hypertrophy)", exercises: ["Deadlifts: 4x8-10", "Lat Pulldown: 3x10-15", "Incline Dumbbell Press: 3x10-15", "Leg Press: 3x12-15", "Hanging Knee Raises: 3x15"] },
                                        { day: "Day 3 (Fri)", key: "fri", title: "Full Body C (Conditioning)", exercises: ["Dumbbell Squat to Press: 3x15", "Push-ups: 3x to failure", "Renegade Rows: 3x10 (each arm)", "Kettlebell Swings (or DB): 3x20", "Side Planks: 3x45s (each side)"] },
                                        { day: "Day 4 (Tue)", key: "tue", title: "Active Rest", exercises: ["Cardio: 30 min HIIT (e.g., 1 min on, 1 min off)"] },
                                        { day: "Day 5 (Thu)", key: "thu", title: "Active Rest", exercises: ["Cardio: 30-40 min light-moderate intensity"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        },
                        '4day': {
                            name: "4-Day General Fitness Plan",
                            description: "A 4-day Upper/Lower split for balanced, all-around fitness.",
                            phases: [
                                {
                                    name: "Phase 1: Foundation (Weeks 1-6)",
                                    description: "Focus on building strength and work capacity with compound lifts.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A", exercises: ["Dumbbell Bench Press: 3x10-12", "Lat Pulldown: 3x10-12", "Dumbbell Shoulder Press: 3x10-12", "Dumbbell Curls: 2x12", "Tricep Pushdowns: 2x12"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A", exercises: ["Goblet Squats: 3x10-12", "Romanian Deadlifts (DB): 3x10-12", "Leg Press: 3x12-15", "Calf Raises: 3x15", "Ab Crunches: 3x20"] },
                                        { day: "Day 3 (Thu)", key: "thu", title: "Upper Body B", exercises: ["Incline DB Press: 3x10-12", "Seated Cable Row: 3x10-12", "Lateral Raises: 3x15", "Hammer Curls: 2x12", "Overhead Extension: 2x12"] },
                                        { day: "Day 4 (Fri)", key: "fri", title: "Lower Body B", exercises: ["Leg Press: 3x10-12", "Walking Lunges: 3x10 (each leg)", "Leg Curls: 3x12-15", "Leg Extensions: 3x12-15", "Plank: 3x60s"] },
                                        { day: "Day 5 (Wed)", key: "wed", title: "Active Rest", exercises: ["Cardio: 30-40 min light-moderate intensity (e.g., Incline Walk)"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Progression (Weeks 7+)",
                                    description: "Increase intensity and volume.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A (Strength)", exercises: ["Barbell Bench Press: 4x8-10", "Barbell Row: 4x8-10", "Overhead Press: 3x8-10", "Dumbbell Curls: 3x12", "Tricep Pushdowns: 3x12"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A (Strength)", exercises: ["Barbell Squats: 4x8-10", "Romanian Deadlifts: 3x8-10", "Leg Press: 3x10-12", "Calf Raises: 4x15", "Hanging Knee Raises: 3x15"] },
                                        { day: "Day 3 (Thu)", key: "thu", title: "Upper Body B (Hypertrophy)", exercises: ["Incline DB Press: 3x10-15", "Seated Cable Row: 3x10-15", "DB Shoulder Press: 3x10-15", "Lateral Raises: 3x15-20", "Hammer Curls: 3x10-15", "Overhead Extension: 3x10-15"] },
                                        { day: "Day 4 (Fri)", key: "fri", title: "Lower Body B (Hypertrophy)", exercises: ["Leg Press: 4x15-20", "Bulgarian Split Squats: 3x10 (each leg)", "Leg Curls: 4x15-20", "Leg Extensions: 4x15-20", "Plank: 3x90s"] },
                                        { day: "Day 5 (Wed)", key: "wed", title: "Active Rest", exercises: ["Cardio: 30-40 min light-moderate intensity"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        },
                        '5day': {
                            name: "5-Day General Fitness Plan",
                            description: "A 5-day plan balancing resistance and cardio for all-around health.",
                            phases: [
                                {
                                    name: "Phase 1: Foundation (Weeks 1-4)",
                                    description: "Focus on building strength and work capacity with compound lifts.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A", exercises: ["Bench Press: 3x8-12", "Lat Pulldown: 3x10-15", "Shoulder Press: 3x10-12", "Dumbbell Curls: 2x12-15", "Tricep Pushdowns: 2x12-15"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A", exercises: ["Squats: 3x8-12", "Romanian Deadlifts: 3x10-15", "Leg Press: 3x12-15", "Calf Raises: 3x15-20", "Ab Crunches: 3x20"] },
                                        { day: "Day 3 (Wed)", key: "wed", title: "Cardio & Core", exercises: ["Cardio: 30-40 min light-moderate intensity (e.g., Incline Walk)", "Plank: 3x60s", "Side Planks: 3x30s (each side)", "Crunches: 3x20"] },
                                        { day: "Day 4 (Thu)", key: "thu", title: "Upper Body B", exercises: ["Incline DB Press: 3x10-15", "Seated Cable Row: 3x10-15", "Lateral Raises: 3x15-20", "Hammer Curls: 2x12-15", "Overhead Extension: 2x12-15"] },
                                        { day: "Day 5 (Fri)", key: "fri", title: "Lower Body B", exercises: ["Deadlifts: 3x6-10", "Walking Lunges: 3x10-12 (each leg)", "Leg Curls: 3x15-20", "Leg Extensions: 3x15-20", "Hanging Knee Raises: 3x15"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                },
                                {
                                    name: "Phase 2: Intensity (Weeks 5+)",
                                    description: "Increase intensity with more volume and HIIT cardio.",
                                    days: [
                                        { day: "Day 1 (Mon)", key: "mon", title: "Upper Body A (Intensity)", exercises: ["Bench Press: 4x8-10", "Lat Pulldown: 4x10-12", "Shoulder Press: 3x10-12", "Superset: DB Curls (3x12) & Tricep Pushdowns (3x15)"] },
                                        { day: "Day 2 (Tue)", key: "tue", title: "Lower Body A (Intensity)", exercises: ["Squats: 4x8-10", "Romanian Deadlifts: 3x10-12", "Leg Press: 4x15-20", "Calf Raises: 4x20", "Hanging Knee Raises: 3x15"] },
                                        { day: "Day 3 (Wed)", key: "wed", title: "Cardio & Core (HIIT)", exercises: ["Cardio: 25 min HIIT (1 min on, 1 min off)", "Plank: 3x90s", "Side Planks: 3x45s (each side)", "Cable Crunches: 3x15"] },
                                        { day: "Day 4 (Thu)", key: "thu", title: "Upper Body B (Intensity)", exercises: ["Incline DB Press: 4x10-12", "Seated Cable Row: 4x10-12", "Lateral Raises: 4x15-20", "Superset: Hammer Curls (3x12) & Overhead Extension (3x15)"] },
                                        { day: "Day 5 (Fri)", key: "fri", title: "Lower Body B (Intensity)", exercises: ["Deadlifts: 4x6-8", "Walking Lunges: 3x12 (each leg)", "Leg Curls: 4x15-20", "Leg Extensions: 4x15-20", "Ab Rollout: 3x to failure"] },
                                        { day: "Day 6 (Sat)", key: "sat", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] },
                                        { day: "Day 7 (Sun)", key: "sun", title: "Rest Day", exercises: ["Rest and recover. Focus on diet and hydration."] }
                                    ]
                                }
                            ]
                        }
                    }
                },
                dietPlans: {
                    veg: {
                        name: "Vegetarian Diet Plan",
                        description: "A high-protein vegetarian plan focusing on paneer, tofu, lentils, and sattu.",
                        meals: [
                            { id: "meal-1", title: "Meal 1: Breakfast", options: [
                                { name: "Option 1: 'Natural' Protein Shake", desc: "1 cup thick curd, 2-3 tbsp Sattu, 1 tbsp chia seeds, 1/2 banana, Water/Milk." },
                                { name: "Option 2: Solid Meal", desc: "2-3 Moong Dal Chillas or 1 bowl Poha/Upma (with peanuts & peas)." },
                                { name: "Option 3: Simple", desc: "1 bowl sprouts salad and 1 glass salted lassi/buttermilk." }
                            ]},
                            { id: "meal-2", title: "Meal 2: Lunch", options: [
                                { name: "Option 1: Classic", desc: "1 large bowl Dal (Rajma/Chana), 1 small bowl Brown Rice (or 2 Rotis), 1 large bowl salad." },
                                { name: "Option 2: Paneer/Tofu", desc: "100-150g Paneer/Tofu Bhurji, 2 wholewheat Rotis, Side of curd." },
                                { name: "Option 3: Salad Meal", desc: "Large 'Buddha Bowl' (chickpeas, quinoa, roasted vegetables)." }
                            ]},
                            { id: "meal-3", title: "Snack", options: [
                                { name: "Option 1", desc: "An apple or banana" },
                                { name: "Option 2", desc: "A handful of roasted chana" },
                                { name: "Option 3", desc: "1 glass of buttermilk (chaas) or a handful of almonds (15-20)" }
                            ]},
                            { id: "meal-4", title: "Meal 3: Dinner (Pre-Workout Meal)", options: [
                                { name: "Option 1: High Protein", desc: "150g Paneer Tikka with sautéed vegetables and 1 large green salad." },
                                { name: "Option 2: Lentil Focus", desc: "1 large bowl thick Dal/Sambar, 1 small bowl rice OR 1 Roti." },
                                { name: "Option 3: Soy", desc: "Soy Chunk (Nutrela) curry with 1-2 wholewheat Rotis." }
                            ]},
                            { id: "meal-5", title: "Meal 4: Post-Workout Recovery", options: [
                                { name: "Option 1: Best Choice", desc: "The 'Natural' Protein Shake (Sattu, curd, etc.) - fast-digesting." },
                                { name: "Option 2: Simple", desc: "1 glass of milk + 1 banana." },
                                { name: "Option 3: Light", desc: "100g Paneer (lightly salted) or a small bowl of curd." }
                            ]}
                        ]
                    },
                    nonVeg: {
                        name: "Non-Vegetarian Diet Plan",
                        description: "A high-protein plan including eggs, chicken, and fish, with Indian flavors.",
                        meals: [
                            { id: "meal-1", title: "Meal 1: Breakfast", options: [
                                { name: "Option 1: Eggs", desc: "4-5 Egg Whites (boiled or scrambled) + 1-2 whole eggs & 2 slices wholewheat toast." },
                                { name: "Option 2: Oats", desc: "1 bowl Oatmeal with milk, nuts, and 1/2 banana. (Add 2 boiled eggs on the side)." },
                                { name: "Option 3: Indian", desc: "2-3 Moong Dal Chillas. (Add 2 boiled eggs on the side)." }
                            ]},
                            { id: "meal-2", title: "Meal 2: Lunch", options: [
                                { name: "Option 1: Chicken", desc: "150g grilled/tandoori Chicken Breast, 1 small bowl Brown Rice (or 2 Rotis), 1 large bowl salad." },
                                { name: "Option 2: Fish", desc: "150g grilled/steamed Fish (e.g., Rohu, Surmai), 1 small bowl Brown Rice, 1 large bowl salad." },
                                { name: "Option 3: Eggs & Lentils", desc: "1 large bowl Dal (Rajma/Chana) + 3 Egg Whites (boiled), 2 Rotis, Side of curd." }
                            ]},
                            { id: "meal-3", title: "Snack", options: [
                                { name: "Option 1", desc: "An apple or banana" },
                                { name: "Option 2", desc: "A handful of roasted chana" },
                                { name: "Option 3", desc: "1 glass of buttermilk (chaas) or a handful of almonds (15-20)" }
                            ]},
                            { id: "meal-4", title: "Meal 3: Dinner (Pre-Workout Meal)", options: [
                                { name: "Option 1: Chicken Curry", desc: "150g Chicken Curry (less oil, home-style) with 1-2 wholewheat Rotis OR 1 small bowl rice." },
                                { name: "Option 2: Fish Tikka", desc: "150g Fish Tikka with sautéed vegetables and 1 large green salad." },
                                { name: "Option 3: Egg Bhurji", desc: "5-6 Egg Bhurji (scramble) with 2 wholewheat Rotis." }
                            ]},
                            { id: "meal-5", title: "Meal 4: Post-Workout Recovery", options: [
                                { name: "Option 1: Best Choice", desc: "1 glass of milk + 1-2 bananas. (Fast-digesting and simple)." },
                                { name: "Option 2: Light Meal", desc: "100g grilled Chicken or Paneer (lightly salted)." },
                                { name: "Option 3: Simple", desc: "3 Boiled Egg Whites." }
                            ]}
                        ]
                    }
                }
            };

            // --- Global Variables ---
            let goalChart;
            let userProfile = {};
            let weightHistory = [];
            let waterData = {};
            let completedWorkouts = [];
            
            // --- Page Navigation ---
            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page-section');

            function navigateTo(targetId) {
                navButtons.forEach(b => b.classList.remove('active'));
                const activeBtn = document.querySelector(`.nav-btn[data-target="${targetId}"]`);
                if (activeBtn) activeBtn.classList.add('active');
                
                pages.forEach(page => {
                    page.classList.remove('active');
                    if (page.id === targetId) {
                        page.classList.add('active');
                    }
                });

                if (targetId === 'tracker-page' || targetId === 'goals-page') {
                    updateGoalChart();
                }
                if (targetId === 'tracker-page') {
                    renderWeightHistory();
                    renderCalendar();
                }
                if (targetId === 'workout-page') {
                    renderFullWorkoutPlan();
                }
                if (targetId === 'diet-page') {
                    renderDietPlan();
                }
                if (targetId === 'goals-page') {
                    updateHealthMetrics();
                }
            }

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    navigateTo(targetId);
                });
            });

            // --- Dashboard Logic ---
            const dayButtons = document.querySelectorAll('.day-btn');
            const dashboardWorkout = document.getElementById('dashboard-workout');
            const dashboardWorkoutSubtitle = document.getElementById('dashboard-workout-subtitle');
            const dashboardSchedule = document.getElementById('dashboard-schedule');
            const workoutCompleteContainer = document.getElementById('workout-complete-container');

            // NEW: Helper function to parse and format exercises
            function getFormattedExerciseHtml(exercises) {
                if (!exercises || exercises.length === 0) {
                    return '<p class="text-gray-500">No exercises found.</p>';
                }
                // UPDATED: New "proper" workout format
                return exercises.map(ex => {
                    const parts = ex.split(':');
                    const exerciseName = parts[0].trim();
                    const setsReps = parts[1] ? parts[1].trim() : '';
                    return `
                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <span class="font-medium text-gray-800">${exerciseName}</span>
                            <span class="text-gray-600 text-sm">${setsReps}</span>
                        </div>
                    `;
                }).join('');
            }

            dayButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const day = btn.getAttribute('data-day');
                    
                    dayButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const dietKey = userProfile.diet || 'veg';
                    
                    // NEW: Updated logic for workout plan
                    const currentPlanKey = userProfile.goal || 'fatLoss';
                    const currentFreqKey = userProfile.frequency || '3day'; // Default to 3day if not set
                    
                    if (!appData.workoutPlans[currentPlanKey] || !appData.workoutPlans[currentPlanKey][currentFreqKey]) {
                        dashboardWorkoutSubtitle.textContent = "Please set your Profile first.";
                        dashboardWorkout.innerHTML = `<p class="text-gray-500">Select your Goal and Frequency in your Profile to see your plan.</p>`;
                        updateWorkoutCompleteButton(false);
                    } else {
                        const workoutPlan = appData.workoutPlans[currentPlanKey][currentFreqKey];
                        
                        // NEW: Pull from Phase 1 for Dashboard
                        const workoutData = workoutPlan.phases[0].days.find(d => d.key === day);
                        
                        // NEW: Update subtitle with phase info
                        dashboardWorkoutSubtitle.textContent = `Showing: ${workoutPlan.name} (Phase 1)`;

                        if (workoutData) {
                            // UPDATED: Use new "proper" formatting
                            dashboardWorkout.innerHTML = `
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">${workoutData.title}</h3>
                                <div class="space-y-1">
                                    ${getFormattedExerciseHtml(workoutData.exercises)}
                                </div>
                            `;
                            updateWorkoutCompleteButton(workoutData.title.toLowerCase().indexOf('rest') === -1);
                        } else {
                            dashboardWorkout.innerHTML = `<p class="text-gray-500">Workout not found for this day.</p>`;
                            updateWorkoutCompleteButton(false);
                        }
                    }
                    
                    // NEW: DYNAMIC SCHEDULE GENERATION
                    const workoutTime = userProfile.workoutTime || '20:00';
                    let dayType = 'off'; // sun, sat
                    if (['mon', 'tue'].includes(day)) dayType = 'short';
                    if (['wed', 'thu', 'fri'].includes(day)) dayType = 'long';

                    // FIX: Pass 'day' (as dayKey) into the function
                    const scheduleData = generateDynamicSchedule(day, dayType, workoutTime, dietKey);
                    let scheduleHtml = '<div class="space-y-4">';
                    if (scheduleData.error) {
                        scheduleHtml += `<div class="p-4 bg-red-100 text-red-700 rounded-md"><strong>Schedule Conflict:</strong> ${scheduleData.error}</div>`;
                    }
                    scheduleData.schedule.forEach(item => {
                        scheduleHtml += `
                            <div class="flex">
                                <div class="w-24 text-sm font-medium text-gray-600">${item.time}</div>
                                <div class="flex-1 text-sm text-gray-800">${item.text}</div>
                            </div>
                        `;
                    });

                    scheduleHtml += '</div>';
                    dashboardSchedule.innerHTML = scheduleHtml;
                });
            });

            function selectToday() {
                const today = new Date().getDay();
                const dayMap = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                const todayBtn = document.querySelector(`.day-btn[data-day="${dayMap[today]}"]`);
                if(todayBtn) {
                    todayBtn.click();
                    todayBtn.classList.add('font-bold', 'border-indigo-500');
                }
            }

            // --- Workout Complete Logic ---
            function updateWorkoutCompleteButton(isWorkoutDay) {
                const todayStr = new Date().toDateString();
                const isCompleted = completedWorkouts.includes(todayStr);
                
                if (!isWorkoutDay) {
                    workoutCompleteContainer.innerHTML = '<p class="text-center text-gray-500 font-medium p-3 bg-gray-100 rounded-md">Today is a Rest Day!</p>';
                    return;
                }

                if (isCompleted) {
                    workoutCompleteContainer.innerHTML = '<p class="text-center text-green-700 font-medium p-3 bg-green-100 rounded-md">Workout Completed Today!</p>';
                } else {
                    workoutCompleteContainer.innerHTML = '<button id="complete-workout-btn" class="w-full bg-green-500 text-white px-6 py-3 rounded-md font-medium hover:bg-green-600 transition-colors duration-150">Mark Workout as Complete</button>';
                    document.getElementById('complete-workout-btn').addEventListener('click', () => {
                        const todayStr = new Date().toDateString();
                        if (!completedWorkouts.includes(todayStr)) {
                            completedWorkouts.push(todayStr);
                            localStorage.setItem('completedWorkouts', JSON.stringify(completedWorkouts));
                        }
                        updateWorkoutCompleteButton(true);
                        renderCalendar(); // DESIGN UPDATE: Re-render calendar on complete
                    });
                }
            }

            // --- Water Tracker Logic ---
            const waterCountEl = document.getElementById('water-count');
            const waterPlusBtn = document.getElementById('water-plus-btn');
            const waterMinusBtn = document.getElementById('water-minus-btn');

            function updateWaterTracker() {
                const todayStr = new Date().toDateString();
                if (waterData.date !== todayStr) {
                    waterData.count = 0;
                    waterData.date = todayStr;
                }
                waterCountEl.textContent = waterData.count;
                localStorage.setItem('waterData', JSON.stringify(waterData));
            }

            waterPlusBtn.addEventListener('click', () => {
                if (waterData.count < 99) {
                    waterData.count++;
                    updateWaterTracker();
                }
            });

            waterMinusBtn.addEventListener('click', () => {
                if (waterData.count > 0) {
                    waterData.count--;
                    updateWaterTracker();
                }
            });

            // --- Diet Page Logic (NEW: Dynamic) ---
            const dietPlanTitle = document.getElementById('diet-plan-title');
            const dietPlanDescription = document.getElementById('diet-plan-description');
            const dietPlanContainer = document.getElementById('diet-plan-options-container');

            function renderDietPlan() {
                const dietKey = userProfile.diet || 'veg';
                const plan = appData.dietPlans[dietKey];

                if (!plan) {
                    dietPlanTitle.textContent = "No Diet Plan Selected";
                    dietPlanDescription.textContent = "Please select a dietary preference on your Profile page.";
                    dietPlanContainer.innerHTML = "";
                    return;
                }

                dietPlanTitle.textContent = `Pillar 1: The ${plan.name}`;
                dietPlanDescription.textContent = plan.description;

                dietPlanContainer.innerHTML = plan.meals.map(meal => `
                    <div class="card">
                        <div class="meal-card-header" data-target="${meal.id}-content">
                            <h3 class="text-lg font-semibold text-indigo-700">${meal.title}</h3>
                            <span class="text-xl font-bold">+</span>
                        </div>
                        <div id="${meal.id}-content" class="pt-6 space-y-4 hidden"> <!-- Increased padding/space -->
                            ${meal.options.map(opt => `
                                <div class="border-b border-gray-100 pb-3">
                                    <h4 class="font-semibold text-gray-800">${opt.name}</h4>
                                    <p class="text-gray-600 text-sm">${opt.desc}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                
                const mealCardHeaders = dietPlanContainer.querySelectorAll('.meal-card-header');
                mealCardHeaders.forEach(header => {
                    header.addEventListener('click', () => {
                        const targetId = header.getAttribute('data-target');
                        const content = document.getElementById(targetId);
                        content.classList.toggle('hidden');
                        header.querySelector('span').textContent = content.classList.contains('hidden') ? '+' : '−';
                    });
                });
            }


            // --- Workout Page Logic ---
            const workoutPlanTitle = document.getElementById('workout-plan-title');
            const workoutPlanDescription = document.getElementById('workout-plan-description');
            const workoutPlanContainer = document.getElementById('workout-plan-container');
            // NEW: Age Guidance elements
            const ageGuidanceCard = document.getElementById('age-guidance-card');
            const ageGuidanceTitle = document.getElementById('age-guidance-title');
            const ageGuidanceContent = document.getElementById('age-guidance-content');

            // NEW: Updated to render phases AND age guidance
            function renderFullWorkoutPlan() {
                const age = parseInt(userProfile.age);
                if (!age || age < 16) {
                    ageGuidanceCard.classList.add('hidden');
                } else {
                    ageGuidanceCard.classList.remove('hidden');
                    if (age < 25) {
                        ageGuidanceTitle.textContent = "Age Bracket: Prime (Under 25)";
                        ageGuidanceContent.textContent = "Your body is in its prime for recovery. Focus on progressive overload and pushing the intensity on your main lifts. Don't neglect form.";
                    } else if (age < 40) {
                        ageGuidanceTitle.textContent = "Age Bracket: Peak (25-39)";
                        ageGuidanceContent.textContent = "Focus on consistency and listening to your body. Form is critical. Ensure you are fully warming up before lifts and cooling down after.";
                    } else {
                        ageGuidanceTitle.textContent = "Age Bracket: Master (40+)";
                        ageGuidanceContent.textContent = "Prioritize warm-ups and mobility (10-15 min). Focus on controlled reps over heavy 1-rep maxes. Reduce high-impact exercises if you feel joint pain. An extra rest day is smart.";
                    }
                }

                const currentPlanKey = userProfile.goal || 'fatLoss';
                const currentFreqKey = userProfile.frequency || '3day';
                
                if (!appData.workoutPlans[currentPlanKey] || !appData.workoutPlans[currentPlanKey][currentFreqKey]) {
                    workoutPlanTitle.textContent = "No Plan Selected";
                    workoutPlanDescription.textContent = "Please select your Goal and Frequency on your Profile page.";
                    workoutPlanContainer.innerHTML = "";
                    return;
                }
                
                const plan = appData.workoutPlans[currentPlanKey][currentFreqKey];

                workoutPlanTitle.textContent = plan.name;
                workoutPlanDescription.textContent = plan.description;
                
                workoutPlanContainer.innerHTML = plan.phases.map(phase => {
                    return `
                        <div class="mb-10">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">${phase.name}</h3>
                            <p class="text-gray-600 mb-6">${phase.description}</p>
                            <div class="space-y-6">
                                ${phase.days.map(day => `
                                    <div class="border border-gray-200 rounded-lg p-6">
                                        <h4 class="text-lg font-semibold text-gray-800 mb-4">${day.day} - ${day.title}</h4>
                                        <div class="space-y-2">
                                            ${getFormattedExerciseHtml(day.exercises)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // --- Tracker Page Logic ---
            const weightInput = document.getElementById('weight-input');
            const logWeightBtn = document.getElementById('log-weight-btn');
            const weightHistoryTable = document.getElementById('weight-history-table');
            const calendarGrid = document.getElementById('consistency-calendar');

            logWeightBtn.addEventListener('click', () => {
                const weight = parseFloat(weightInput.value);
                if (weight > 0) {
                    const todayStr = new Date().toDateString();
                    const newEntry = { date: todayStr, weight: weight };
                    
                    const existingEntryIndex = weightHistory.findIndex(e => e.date === todayStr);
                    if (existingEntryIndex > -1) {
                        weightHistory[existingEntryIndex] = newEntry;
                    } else {
                        weightHistory.push(newEntry);
                    }
                    
                    weightHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem('weightHistory', JSON.stringify(weightHistory));
                    
                    renderWeightHistory();
                    updateGoalChart();
                    weightInput.value = '';
                }
            });

            function renderWeightHistory() {
                weightHistoryTable.innerHTML = '';
                if (weightHistory.length === 0) {
                    weightHistoryTable.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500 py-4">No weight logged yet.</td></tr>';
                    return;
                }
                weightHistory.forEach(entry => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-sm text-gray-700">${entry.date}</td>
                        <td class="py-3 px-4 text-sm text-gray-800 font-medium">${entry.weight} kg</td>
                    `;
                    weightHistoryTable.appendChild(row);
                });
            }

            // DESIGN UPDATE: Rewritten calendar function
            function renderCalendar() {
                calendarGrid.innerHTML = '';
                const duration = parseInt(userProfile.duration) || 8;
                const totalWeeks = duration > 0 ? duration : 8; // Default to 8 weeks
                const totalDays = totalWeeks * 7;
                
                // Add Day Headers
                const weekDays = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                weekDays.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day-header'; // New class
                    dayEl.textContent = day;
                    calendarGrid.appendChild(dayEl);
                });
                
                // Align calendar to the start of the current week (Sunday)
                const today = new Date();
                const todayDateStr = today.toDateString();
                const firstDay = new Date(today);
                firstDay.setDate(firstDay.getDate() - today.getDay()); 

                for (let i = 0; i < totalDays; i++) {
                    const day = new Date(firstDay);
                    day.setDate(day.getDate() + i);
                    
                    const dayEl = document.createElement('div');
                    dayEl.textContent = day.getDate();
                    
                    const dayStr = day.toDateString();
                    const isCompleted = completedWorkouts.includes(dayStr);
                    const isToday = (dayStr === todayDateStr);
                    
                    dayEl.className = 'calendar-day'; // New class
                    if (isCompleted) {
                        dayEl.classList.add('completed');
                    }
                    if (isToday) {
                        dayEl.classList.add('today'); // New class
                    }
                    calendarGrid.appendChild(dayEl);
                }
            }
            
            // --- Goal Chart Logic ---
            const goalChartTitle = document.getElementById('goal-chart-title');
            // NEW: Health metrics elements
            const bmiDisplay = document.getElementById('bmi-display');
            const bmrDisplay = document.getElementById('bmr-display');

            function updateGoalChart() {
                const startWeight = parseFloat(userProfile.startWeight) || 0;
                const goalWeight = parseFloat(userProfile.goalWeight) || startWeight - 10;
                const duration = parseInt(userProfile.duration) || 8;
                
                if (startWeight === 0) {
                    goalChartTitle.textContent = "Set Starting Weight in Profile";
                } else {
                    goalChartTitle.textContent = `Your ${duration}-Week Goal: ${startWeight}kg to ~${goalWeight}kg`;
                }

                const ctx = document.getElementById('goal-chart').getContext('2d');
                
                const labels = [];
                for (let i = 0; i <= duration; i++) {
                    labels.push(`W${i}`);
                }
                
                let progressData = new Array(labels.length).fill(null);
                if (weightHistory.length > 0) {
                    const sortedHistory = [...weightHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const firstEntryDate = new Date(sortedHistory[0].date);
                    
                    sortedHistory.forEach(entry => {
                        const entryDate = new Date(entry.date);
                        const diffTime = Math.abs(entryDate - firstEntryDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const week = Math.floor(diffDays / 7);
                        if(week >= 0 && week < labels.length) {
                             progressData[week] = entry.weight;
                        }
                    });
                } else if (startWeight > 0) {
                    progressData[0] = startWeight;
                }

                const goalData = [];
                const weeklyLoss = (startWeight - goalWeight) / duration;
                for (let i = 0; i < labels.length; i++) {
                    goalData.push(parseFloat((startWeight - (weeklyLoss * i)).toFixed(1)));
                }
                
                const datasets = [
                    {
                        label: 'Your Goal Path',
                        data: goalData,
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: 'rgba(79, 70, 229, 0.05)',
                        fill: true,
                        tension: 0.1,
                        borderDash: [5, 5]
                    },
                    {
                        label: 'Your Progress',
                        data: progressData,
                        borderColor: 'rgb(22, 163, 74)',
                        backgroundColor: 'rgba(22, 163, 74, 0.1)',
                        fill: false,
                        tension: 0.1,
                        borderWidth: 3
                    }
                ];

                const minY = Math.min(goalWeight, startWeight) - 2;
                const maxY = Math.max(goalWeight, startWeight) + 2;

                if (goalChart) {
                    goalChart.data.labels = labels;
                    goalChart.data.datasets = datasets;
                    goalChart.options.scales.y.min = minY;
                    goalChart.options.scales.y.max = maxY;
                    goalChart.update();
                } else {
                    goalChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    title: { display: true, text: 'Weight (kg)' },
                                    min: minY,
                                    max: maxY
                                },
                                x: {
                                    title: { display: true, text: 'Time (Weeks)' }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.parsed.y} kg`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            // NEW: Health Metrics Calculator
            function updateHealthMetrics() {
                const height = parseFloat(userProfile.height);
                const weight = parseFloat(userProfile.startWeight);
                const age = parseInt(userProfile.age);

                if (height && weight && height > 0 && weight > 0) {
                    const heightM = height / 100;
                    const bmi = (weight / (heightM * heightM)).toFixed(1);
                    bmiDisplay.textContent = `Your BMI: ${bmi}`;
                } else {
                    bmiDisplay.textContent = `Your BMI: --`;
                }

                if (height && weight && age && height > 0 && weight > 0 && age > 0) {
                    // Mifflin-St Jeor equation for males
                    const bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
                    bmrDisplay.textContent = `Your Est. BMR: ${bmr.toFixed(0)} Calories/Day`;
                } else {
                    bmrDisplay.textContent = `Your Est. BMR: --`;
                }
            }

            // --- Profile Page Logic ---
            const setupModal = document.getElementById('setup-modal');
            const goToProfileBtn = document.getElementById('go-to-profile-btn');
            const dashboardTitle = document.getElementById('dashboard-title');
            
            const profileNameInput = document.getElementById('profile-name');
            const profileAgeInput = document.getElementById('profile-age'); // NEW
            const profileHeightInput = document.getElementById('profile-height'); // NEW
            const profileStartWeightInput = document.getElementById('profile-start-weight');
            const profileGoalWeightInput = document.getElementById('profile-goal-weight');
            const profileDurationInput = document.getElementById('profile-duration');
            const dietChoiceBtns = document.querySelectorAll('#diet-choices .goal-choice-btn');
            const frequencyChoiceBtns = document.querySelectorAll('#frequency-choices .goal-choice-btn'); 
            const profileWorkoutTimeSelect = document.getElementById('profile-workout-time'); 
            const goalChoiceBtns = document.querySelectorAll('#goal-choices .goal-choice-btn');
            const saveProfileBtn = document.getElementById('save-profile-btn');
            const resetAppBtn = document.getElementById('reset-app-btn');
            const profileSavedMsg = document.getElementById('profile-saved-msg');

            // NEW: Populate workout time select
            function populateWorkoutTimes() {
                for (let i = 5; i <= 22; i++) {
                    const hour = i.toString().padStart(2, '0');
                    const option = document.createElement('option');
                    option.value = `${hour}:00`;
                    
                    let displayHour = i;
                    let ampm = 'AM';
                    if (i === 12) {
                        ampm = 'PM';
                    } else if (i > 12) {
                        displayHour = i - 12;
                        ampm = 'PM';
                    } else if (i === 0) {
                        displayHour = 12;
                    }
                    option.textContent = `${displayHour}:00 ${ampm}`;
                    profileWorkoutTimeSelect.appendChild(option);
                }
            }

            goToProfileBtn.addEventListener('click', () => {
                setupModal.classList.add('hidden');
                navigateTo('profile-page');
            });

            dietChoiceBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    dietChoiceBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    userProfile.diet = btn.dataset.diet; // This sets the choice in memory
                });
            });

            // NEW: Frequency choice listener
            frequencyChoiceBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    frequencyChoiceBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    userProfile.frequency = btn.dataset.frequency; // This sets the choice in memory
                });
            });

            goalChoiceBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    goalChoiceBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    userProfile.goal = btn.dataset.goal; // This sets the choice in memory
                });
            });

            saveProfileBtn.addEventListener('click', () => {
                userProfile.name = profileNameInput.value;
                userProfile.age = profileAgeInput.value; // NEW
                userProfile.height = profileHeightInput.value; // NEW
                userProfile.startWeight = profileStartWeightInput.value;
                userProfile.goalWeight = profileGoalWeightInput.value;
                userProfile.duration = profileDurationInput.value;
                userProfile.workoutTime = profileWorkoutTimeSelect.value; 
                
                // This saves the in-memory choices to localStorage
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                
                profileSavedMsg.classList.remove('hidden');
                setTimeout(() => profileSavedMsg.classList.add('hidden'), 2000);
                
                // Now, reload everything based on the new saved data
                loadProfile();
                updateGoalChart();
                updateHealthMetrics(); // NEW
                renderFullWorkoutPlan();
                renderDietPlan();
                selectToday(); // Re-run to update dashboard with new diet
            });

            resetAppBtn.addEventListener('click', () => {
                localStorage.clear();
                window.location.reload();
            });

            function loadProfile() {
                userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
                
                // NEW: Updated check to include age and height
                if (!userProfile.name || !userProfile.diet || !userProfile.goal || !userProfile.frequency || !userProfile.workoutTime || !userProfile.age || !userProfile.height) {
                    setTimeout(() => setupModal.classList.remove('hidden'), 500);
                }

                dashboardTitle.textContent = userProfile.name ? `Welcome, ${userProfile.name}!` : "Welcome! Please set up your profile.";
                
                profileNameInput.value = userProfile.name || '';
                profileAgeInput.value = userProfile.age || ''; // NEW
                profileHeightInput.value = userProfile.height || ''; // NEW
                profileStartWeightInput.value = userProfile.startWeight || '';
                profileGoalWeightInput.value = userProfile.goalWeight || '';
                profileDurationInput.value = userProfile.duration || '';
                profileWorkoutTimeSelect.value = userProfile.workoutTime || '20:00'; 
                
                // This part reads from localStorage and applies the 'active' class on page load
                dietChoiceBtns.forEach(btn => {
                    if (btn.dataset.diet === userProfile.diet) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // NEW: Load frequency choice
                frequencyChoiceBtns.forEach(btn => {
                    if (btn.dataset.frequency === userProfile.frequency) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                goalChoiceBtns.forEach(btn => {
                    if (btn.dataset.goal === userProfile.goal) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            // --- NEW: DYNAMIC SCHEDULE GENERATION LOGIC ---

            // Helper function to parse "HH:MM" string to a Date object
            function parseTime(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const date = new Date();
                date.setHours(hours, minutes, 0, 0);
                return date;
            }

            // Helper function to add minutes to a Date object and return a new Date object
            function addMinutes(date, minutes) {
                return new Date(date.getTime() + minutes * 60000);
            }

            // Helper function to format a Date object to "HH:MM AM/PM"
            function formatTime(date) {
                let hours = date.getHours();
                let minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                minutes = minutes < 10 ? '0' + minutes : minutes;
                return `${hours}:${minutes} ${ampm}`;
            }

            // The new "brain" for schedule generation
            // FIX: Added 'dayKey' as the first parameter
            function generateDynamicSchedule(dayKey, dayType, workoutStartTimeStr, dietKey) {
                const schedule = [];
                let error = null;

                const dietMeals = appData.dietPlans[dietKey].meals;
                const mealNames = {
                    breakfast: dietMeals.find(m => m.id === 'meal-1').title,
                    lunch: dietMeals.find(m => m.id === 'meal-2').title,
                    snack: dietMeals.find(m => m.id === 'meal-3').title,
                    preWorkout: dietMeals.find(m => m.id === 'meal-4').title,
                    postWorkout: dietMeals.find(m => m.id === 'meal-5').title,
                };

                const workoutStart = parseTime(workoutStartTimeStr);
                const workoutEnd = addMinutes(workoutStart, 80); // 80 min workout
                const preWorkoutMealTime = addMinutes(workoutStart, -90); // 1.5 hrs before
                const postWorkoutMealTime = addMinutes(workoutEnd, 15); // 15 mins after
                
                const collegeStart = parseTime("08:30");
                const collegeEndShort = parseTime("14:00");
                const collegeEndLong = parseTime("16:00");

                const wakeTime = parseTime("07:00");
                const sleepTime = parseTime("23:30");

                // --- Define Time Slots ---
                const wakeSlot = { time: formatTime(wakeTime), text: "Wake up. Drink 1L water." };
                const breakfastSlot = { time: formatTime(addMinutes(wakeTime, 30)), text: `<strong>${mealNames.breakfast}</strong>` };
                const lunchSlot = { time: formatTime(parseTime("13:00")), text: `<strong>${mealNames.lunch}</strong> (Packed)` };
                const snackSlot = { time: formatTime(parseTime("17:00")), text: `<strong>${mealNames.snack}</strong>` };
                const sleepSlot = { time: formatTime(sleepTime), text: "In bed. Sleep." };
                
                const workoutSlot = { time: `${formatTime(workoutStart)} - ${formatTime(workoutEnd)}`, text: "<strong>Workout (See Dashboard)</strong>" };
                const preWorkoutSlot = { time: formatTime(preWorkoutMealTime), text: `<strong>${mealNames.preWorkout}</strong>` };
                const postWorkoutSlot = { time: formatTime(postWorkoutMealTime), text: `<strong>${mealNames.postWorkout}</strong>` };

                const collegeShortSlot = { time: `${formatTime(collegeStart)} - ${formatTime(collegeEndShort)}`, text: "<strong>College (Short Day)</strong>" };
                const collegeLongSlot = { time: `${formatTime(collegeStart)} - ${formatTime(collegeEndLong)}`, text: "<strong>College (Long Day)</strong>" };
                const restDaySlot = { time: "Evening", text: "<strong>REST DAY.</strong> No gym. Focus on diet." };

                // --- Build Schedule Based on Day Type ---
                if (dayType === 'off') {
                    if(dayKey === 'sat') {
                        schedule.push(wakeSlot, breakfastSlot, lunchSlot, snackSlot, restDaySlot, sleepSlot);
                    } else {
                        schedule.push(wakeSlot, breakfastSlot, lunchSlot, snackSlot, preWorkoutSlot, workoutSlot, postWorkoutSlot, sleepSlot);
                    }
                } else if (dayType === 'short') {
                    schedule.push(wakeSlot, breakfastSlot, collegeShortSlot);
                    // Check for conflicts
                    if (workoutStart >= collegeStart && workoutStart < collegeEndShort) {
                        error = "Your workout time conflicts with your 'Short Day' college schedule (8:30 AM - 2:00 PM). Please pick a different time.";
                    }
                    schedule.push(lunchSlot, snackSlot, preWorkoutSlot, workoutSlot, postWorkoutSlot, sleepSlot);
                } else if (dayType === 'long') {
                    schedule.push(wakeSlot, breakfastSlot, collegeLongSlot);
                    // Check for conflicts
                    if (workoutStart >= collegeStart && workoutStart < collegeEndLong) {
                        error = "Your workout time conflicts with your 'Long Day' college schedule (8:30 AM - 4:00 PM). Please pick a different time.";
                    }
                    schedule.push(lunchSlot, snackSlot, preWorkoutSlot, workoutSlot, postWorkoutSlot, sleepSlot);
                }

                // Sort the schedule by time
                const sortedSchedule = schedule.sort((a, b) => {
                    // Handle non-time-based strings like "Evening"
                    if (a.time.includes(":") && !b.time.includes(":")) return -1;
                    if (!a.time.includes(":") && b.time.includes(":")) return 1;
                    if (!a.time.includes(":") && !b.time.includes(":")) return 0;
                    
                    const timeA = parseTime(a.time.split(' - ')[0]); // Get start time
                    const timeB = parseTime(b.time.split(' - ')[0]);
                    return timeA - timeB;
                });
                
                // Remove duplicates (e.g., if a rest day is also a workout day)
                const uniqueSchedule = [];
                const seenTimes = new Set();
                for (const item of sortedSchedule) {
                    if (dayKey === 'sat' && (item.text.includes("Workout") || item.text.includes("Post-Workout"))) {
                        continue;
                    }
                    if (dayKey === 'fri' && dayType !== 'off' && (item.text.includes("Workout") || item.text.includes("Post-Workout"))) {
                         if (!seenTimes.has(restDaySlot.time)) {
                            uniqueSchedule.push(restDaySlot);
                            seenTimes.add(restDaySlot.time);
                         }
                         continue;
                    }

                    if (!seenTimes.has(item.time)) {
                        uniqueSchedule.push(item);
                        seenTimes.add(item.time);
                    }
                }

                return { schedule: uniqueSchedule, error: error };
            }

            // --- Data Initialization ---
            function initApp() {
                populateWorkoutTimes(); // NEW
                loadProfile();
                weightHistory = JSON.parse(localStorage.getItem('weightHistory')) || [];
                waterData = JSON.parse(localStorage.getItem('waterData')) || { count: 0, date: new Date().toDateString() };
                completedWorkouts = JSON.parse(localStorage.getItem('completedWorkouts')) || [];
                
                updateWaterTracker();
                updateGoalChart();
                updateHealthMetrics(); // NEW
                renderFullWorkoutPlan();
                renderDietPlan();
                selectToday();
            }

            initApp();
        });
    </script>
</body>
</html>
